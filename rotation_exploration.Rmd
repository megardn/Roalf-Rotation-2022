---
title: "rotation_exploration"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

load packages

```{r Install/Load packages, echo=FALSE, message=FALSE, warning=FALSE}
if(!require('pacman')) {
  install.packages('pacman')
}
pacman::p_load(tidyverse)
```

## Clinical Data

### PNC1 Data 

Matching to see how many 7T glucest participants are part of PNC

Load glucest subject list extracted from .xls (list from David 1/13/22)

```{r load glucest}
glucest <- read.csv("data/7t_dates.csv", header=T) 
names(glucest)
str(glucest)
count(glucest)
```

Loading PNC subject list (PMACS LPC mapped)

``` {r load pnc dx}
pnc <- read.csv("/Users/megardn/ImageData/PMACS_remote/clinical/n1601_diagnosis_dxpmr_20170509.csv", header=T)
names(pnc)
str(pnc)
```

join dataframes
```{r join, echo=FALSE}
merge <- inner_join(glucest, pnc,
  by = c("BBLID"="bblid"),
  copy = FALSE,
  keep = FALSE,
  na_matches= "never")
n_distinct(merge$BBLID) #count unique ppts in both
names(merge)
```

### RedCap Data 

Combining data from Kosha from later RedCap studies with PNC1 data from LPC

Diagnoses across time for 7T participants

``` {r load.redcap}
#load in longitudinal redcap diagnosis data
dx <- read.csv("data/diagnosis_long.csv", header = TRUE, stringsAsFactors = F, na = "")
names(dx)
```

``` {r}
redcap <- dx %>% select(BBLID, DODIAGNOSIS, HSTATUS, AXIS1_DX1, allaxis1desc, GASR_CURRENT, AGEONSET_AXIS1, AGEONSET_CLINICRISK, dx_pscat, timepoint)
names(redcap)
#drop 22q subjects
redcap <- subset(redcap, HSTATUS != "22q" | is.na(HSTATUS))
```

### Diagnoses

Initialize a dataframe to store counts as we go
``` {r}
dx_sum <- data.frame(Variable=character(),
                     Frequency=integer(),
                     Note=character(),
                     stringsAsFactors=F)
```

find subjects with multiple CAPA diagnoses

``` {r}
length(which(redcap$timepoint==2))

#append to summary df
dx_sum[nrow(dx_sum) + 1,] = c("CAPA", length(which(redcap$timepoint==2)), "subjects with 2+ diagnoses in REDCap (CAPA)")
```

76 subjects have 2 or more dx only including CAPA data

combine dataframes
```{r}
#make each df have the same number/names of columns
empty_cols <- c("X7T_date", "ONM_7T_date", "scanid", "goassessDxpmr4", "goassessDxpmSep15", "goassessDxpmr6", "goassessDxpmr7") 
redcap2 <- redcap #copy dataframe before adding empty columns
redcap2 <- redcap2[ , empty_cols] <- NA
empty_cols2 <- c("DODIAGNOSIS", "HSTATUS", "AXIS1_DX1", "allaxis1desc", "GASR_CURRENT", "AGEONSET_AXIS1", "AGEONSET_CLINICRISK", "dx_pscat")
merge[ , empty_cols2]<- NA
merge[ , "timepoint"] <- 0 #no dates for PNC dx, setting timepoint to 0

names(redcap2)
names(merge)

total <- rbind(redcap2, merge)
total
```


find numbers - shouldn't be any overlaps between dx listed in redcap and dx from PNC1 since they're different instruments

``` {r counts}
uniq <- data.frame(table(total$BBLID)) #find frequency of each ID in dx list
names(uniq)
uniq <- uniq %>% rename(BBLID=Var1) #rename variable

sum(is.na(uniq$BBLID))
nrow(uniq) #number of unique subjects from 7T dataset with diagnoses in PNC and/or redcap

#append to summary df
dx_sum[nrow(dx_sum) + 1,] = c("unique_dx", nrow(uniq), "number unique subjects with diagnoses in PNC Goassess and/or REDCap CAPA")
```

108 unique subjects with diagnoses (PNC and/or redcap)

```{r followups}
follow <- filter(uniq, Freq > 1)
summary(follow)
nrow(follow)

#append to summary df
dx_sum[nrow(dx_sum) + 1,] = c("multi_dx", nrow(follow), "number unique subjects with 2+ diagnoses in PNC Goassess and/or REDCap CAPA")
```

84 subjects with 7T scans have 2 or more diagnoses between PNC or RedCap

Find initial diagnoses of 
``` {r}
#sort diagnoses by order of interview and filter down to earliest dx only
first <- total[order(total$timepoint),] %>% group_by(BBLID) %>% distinct(BBLID, .keep_all=TRUE) %>% select(BBLID, HSTATUS, allaxis1desc, dx_pscat, goassessDxpmr4) %>% mutate(HSTATUS = as.factor(HSTATUS), dx_pscat = as.factor(dx_pscat), goassessDxpmr4 = as.factor(goassessDxpmr4))

summary(first)

#extract dx frequencies
pscat_freq <- as.data.frame(table(first$dx_pscat))
goassess_freq <- as.data.frame(table(first$goassessDxpmr4))
dx_freqtotal <- rbind(pscat_freq, goassess_freq) %>% rename(dx=Var1)

#combining overlapping dx categories across goassess/recap & aggregate across
#NOTE!!! 4PS goassess group may also include some prodrome
levels(dx_freqtotal$dx)
dx_freqtotal$dx <- fct_collapse(dx_freqtotal$dx, "healthy" = c("noDSMdx", "1TD"),
                                "other" = c("2WK", "other"),
                                "prodrome" = c("pro","3PC"),
                                "psych" = c("psy", "4PS"))

#aggregate across
dx_freqtotal <- dx_freqtotal %>% group_by(dx) %>% summarize(Freq=sum(Freq))
dx_freqtotal
```

### GAF

first looking at GASR data included in diagnosis_long.csv

``` {r}
#drop missing gasr
gasr <- redcap %>% drop_na(GASR_CURRENT)

#list subj with >=2 gasr scores
multi_gasr <- gasr %>% subset(timepoint==2) %>% select(BBLID)
#merge to filter to only subj with multiple gasr
gasr_long <- inner_join(gasr, multi_gasr, by = c("BBLID"))

#filter to first and last gasr scores for each subject
gasr_long <- gasr_long[order(gasr_long$timepoint),] %>% group_by(BBLID) %>% slice(c(1,n()))

#calculate change in GASR, save and plot
gasr_change <- gasr_long %>% group_by(BBLID) %>% mutate("gaf_diff"= GASR_CURRENT - lag(GASR_CURRENT), BBLID=as.factor(BBLID)) %>% select(BBLID, gaf_diff) %>% na.omit 
summary(gasr_change$gaf_diff)

#append calculation of gasr to summary df
dx_sum[nrow(dx_sum) + 1,] = c("multi_gasr", nrow(gasr_change), "number unique subjects with 2+ GASR values from REDCap diagnosis.csv")

#plot change in gasr
ggplot(gasr_change, aes(x=gaf_diff)) + 
  geom_histogram(bins=25, color="white", fill= "darkgreen") + 
  labs(title="change in GASR")
```


## To Do:
see how many subjects' diagnoses changed over time
change in GAF over time